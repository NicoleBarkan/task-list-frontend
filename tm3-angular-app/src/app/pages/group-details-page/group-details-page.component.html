<div class="group-details-wrapper" *ngIf="group() as g">
  <div class="container">

    <div class="back-bar">
      <a class="back-link" routerLink="/groups">
        <mat-icon>arrow_back</mat-icon>
        <span>{{ 'GROUP_DETAILS.BACK' | translate }}</span>
      </a>
    </div>

    <section class="hero">
      <div class="hero-main">
        <div class="avatar" aria-hidden="true">
          {{ g.id ?? '?' }}
        </div>
        <div class="hero-info">
          <h1 class="title" [title]="g.title || ''">{{ g.title || '' }}</h1>
          <div class="meta">
            <span class="muted">{{ 'GROUP_DETAILS.USERS_TITLE' | translate }}:</span>
            <span class="count">{{ users().length }}</span>
          </div>
          <div class="meta">
            <span class="muted">{{ 'GROUP_DETAILS.TASKS_TITLE' | translate }}:</span>
            <span class="count">{{ tasks().length }}</span>
          </div>
        </div>
      </div>
    </section>

    <mat-card class="group-card">
      <div class="kv">
        <div class="row">
          <div class="label">{{ 'GROUP_DETAILS.DESCRIPTION' | translate }}</div>
          <div class="value">
            {{ g.description || ('GROUP_DETAILS.NO_DESCRIPTION' | translate) }}
          </div>
        </div>
      </div>
    </mat-card>

    <h3 class="section-title">{{ 'USERS.IN_GROUP_TITLE' | translate }}</h3>
    <mat-card class="tasks-card">
    <div class="table-wrap">
        <table mat-table [dataSource]="users()" class="tasks-table">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let u">{{ u.id }}</td>
          </ng-container>
        <ng-container matColumnDef="username">
            <th mat-header-cell *matHeaderCellDef>{{ 'USERS.USERNAME' | translate }}</th>
            <td mat-cell *matCellDef="let u">{{ u.username }}</td>
        </ng-container>

        <ng-container matColumnDef="firstName">
            <th mat-header-cell *matHeaderCellDef>{{ 'USERS.FIRSTNAME' | translate }}</th>
            <td mat-cell *matCellDef="let u">{{ u.firstName || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="lastName">
            <th mat-header-cell *matHeaderCellDef>{{ 'USERS.LASTNAME' | translate }}</th>
            <td mat-cell *matCellDef="let u">{{ u.lastName || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>{{ 'USERS.ROLES' | translate }}</th>
            <td mat-cell *matCellDef="let u">
            <span *ngIf="u.role?.length; else norole">
              <span
                class="pill"
                *ngFor="let r of u.role"
                style="margin-right:6px"
                [ngClass]="{
                  'role-admin': r === 'ADMIN',
                  'role-manager': r === 'MANAGER',
                  'role-user': r === 'USER'
                }"
              >
                {{ r }}
              </span>
            </span>
            <ng-template #norole>—</ng-template>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="userColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: userColumns;"></tr>
        </table>
    </div>

    <div *ngIf="!users()?.length" class="empty">
        <mat-icon>group</mat-icon>
        <div class="empty-title">{{ 'USERS.NO_USERS' | translate }}</div>
    </div>
    </mat-card>

    <h3 class="section-title">{{ 'GROUP_DETAILS.TASKS_TITLE' | translate }}</h3>
    <mat-card class="tasks-card">
      <div class="table-wrap">
        <table mat-table [dataSource]="tasks()" class="tasks-table">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'ID'">{{ t.id }}</td>
          </ng-container>

          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>{{ 'TASKS.TITLE' | translate }}</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'TASKS.TITLE' | translate">
              <a class="task-link" [routerLink]="['/details', t.id]">{{ t.title }}</a>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>{{ 'TASKS.TYPE' | translate }}</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'TASKS.TYPE' | translate">
              <span
                class="pill"
                [ngClass]="{
                  'type-epic': t.type === 'EPIC',
                  'type-story': t.type === 'STORY',
                  'type-task': t.type === 'TASK',
                  'type-subtask': t.type === 'SUBTASK',
                  'type-bug': t.type === 'BUG'
                }"
              >
                {{ t.type }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>{{ 'TASKS.STATUS' | translate }}</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'TASKS.STATUS' | translate">
              <span
                class="pill"
                [ngClass]="{
                  'status-open': t.status === 'OPEN',
                  'status-progress': t.status === 'IN_PROGRESS',
                  'status-done': t.status === 'DONE'
                }"
              >
                {{ t.status }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="assignedTo">
            <th mat-header-cell *matHeaderCellDef>{{ 'TASKS.ASSIGNED_TO' | translate }}</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'TASKS.ASSIGNED_TO' | translate">
              {{ t.assignedToName || '—' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="updatedOn">
            <th mat-header-cell *matHeaderCellDef>{{ 'TASKS.UPDATED_ON' | translate }}</th>
            <td mat-cell *matCellDef="let t" [attr.data-col]="'TASKS.UPDATED_ON' | translate">
              {{ t.updatedOn | date:'dd.MM.yyyy, HH:mm' : '+0300' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <div *ngIf="(tasks() || []).length === 0" class="empty">
        <mat-icon>inbox</mat-icon>
        <div class="empty-title">{{ 'GROUP_DETAILS.NO_TASKS' | translate }}</div>
      </div>
    </mat-card>
  </div>
</div>
